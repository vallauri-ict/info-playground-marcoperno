var qs = require('querystring');
const util = require('util');
let mysql = require('mysql');
const { json } = require('express');


const users = [];

function login(req, res) {
    let record = req.body;
    let con = mysql.createConnection({
        host: "localhost",
        user: "root",
        password: "",
        database: "consegna_spesa"
    });

    let query = "SELECT nome, cognome, tipo " +
        "FROM persona, tipopersona " +
        "WHERE email=" + con.escape(record.email) + " AND pwd =" + con.escape(record.pwd) + " AND tipopersona_id = tipopersona.id";
    console.log(query);
    con.query(query, function (err, result, fields) {
        if (err) {
            console.log('err');
        }
        else {
            console.log(JSON.stringify(result));
            if (result.length != 0 && result[0].tipo != "cliente") {
                console.log('si')
                req.session.email = record.email;
                req.session.tipo = result[0].tipo;
                res.writeHead(200);
                res.write(result[0].tipo);
                res.end();
            }
            else {

                console.log('no');
                res.writeHead(401, { "Content-Type": "application/json" });
                res.write("Email o password non corretti oppure non sei autorizzato");
                res.end();
            }
        }
    });
}

function logout(req, res) {
    req.session.destroy(function () {
        //res.writeHead(200, { "Content-Type": "application/json" });
        res.write("Logout corretto");
        res.end();
    });
}

function prenotazioneIndex(req, res) {
    let con = mysql.createConnection({
        host: "localhost",
        user: "root",
        password: "",
        database: "consegna_spesa"
    });

    let query = "SELECT  * FROM prenotazione";
    console.log(query);
    con.query(query, async function (err, result, fields) {
        res.writeHead(200, { "Content-Type": "application/json" });
        for(let i=0;i<result.length; i++)
        {
            console.log(JSON.stringify(result[i]));
            result[i]["cliente_persona_email"] = await convertPersona_IdToEmail( result[i]["cliente_persona_id"], con);
            result[i]["volontario_persona_email"] = await convertPersona_IdToEmail( result[i]["volontario_persona_id"], con);
            delete result[i]["cliente_persona_id"];
            delete result[i]["volontario_persona_id"]
            console.log(result[i]["cliente_persona_id"]);

        }
        
        console.log(JSON.stringify(result));
        res.write(JSON.stringify(result));
        res.end();
    });
}

function prenotazioneUpdate(req, res) {
    let con = mysql.createConnection({
        host: "localhost",
        user: "root",
        password: "",
        database: "consegna_spesa"
    });

    let query = "UPDATE ";
    console.log(query);
    con.query(query, async function (err, result, fields) {
        res.writeHead(200, { "Content-Type": "application/json" });
        
        console.log(JSON.stringify(result));
        res.write(JSON.stringify(result));
        res.end();
    });
}

async function convertPersona_IdToEmail( persona_id, con) {
    return new Promise((resolve,reject)=>{
        con.query("SELECT email FROM persona WHERE id =" + con.escape(persona_id), (err, resp) => {
            if (err) {
                reject(err)
            } else {
                resolve(resp[0].email);

            }
        })
    });
}

async function convertEmailToPersona_Id( email, con) {
    return new Promise((resolve,reject)=>{
        con.query("SELECT id FROM persona WHERE email =" + con.escape(email), (err, resp) => {
            if (err) {
                reject(err)
            } else {
                resolve(resp[0].id);

            }
        })
    });
}

module.exports.login = login;
module.exports.logout = logout;
module.exports.prenotazioneIndex = prenotazioneIndex;
module.exports.prenotazioneUpdate = prenotazioneUpdate;
